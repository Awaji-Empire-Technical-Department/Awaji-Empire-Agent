# アンケート機能 (Survey Feature)

## 概要
Discordユーザー向けのアンケートを作成・実施・集計する機能。
Webダッシュボードで作成し、Discord上で周知、Webフォームで回答を行う。

## 主な機能

### 1. アンケート作成 (管理画面)
* タイトル、説明文の設定
* 質問項目の追加（記述式、ラジオボタン、チェックボックス、プルダウン）
* ステータス管理（受付中 / 停止中）
* 結果のリアルタイム確認とCSVダウンロード

### 2. Discord連携
* `/survey list`: 実施中のアンケート一覧を表示
* `/survey my_active`: 自分が作成した稼働中のアンケートを確認
* `/survey announce`: アンケートの回答リンクをチャンネルに投稿（管理者限定）
* **DM通知機能**: 回答完了時にBotから回答者へ「回答の控え」と「編集用リンク」をDM送信

### 3. 回答フォーム
* Discord OAuth2によるログイン必須（なりすまし防止）
* **回答の編集（Upsert）**:
    * ユーザーは回答期間中であれば、何度でも回答を修正可能。
    * 再度フォームを開くと、前回の回答内容が自動入力された状態で表示される。
* **回答完了画面**:
    * 送信成功時にスタイリングされた完了画面を表示し、DM確認を促す。

## 技術仕様

### データベース設計 (`survey_responses`)
* ユーザーIDとアンケートIDの組み合わせでユニーク制約を持たせる（論理上）。
* **保存ロジック**:
    * 新規回答 → `INSERT`
    * 既存回答あり → `UPDATE` (回答内容はJSON形式で上書き保存)

### 通知システム
* Webアプリケーション (`webapp.py`) はBotインスタンスを持たないため、`httpx` を使用してDiscord APIを直接叩くことでDM送信を実現。
* ユーザーがDMを拒否設定にしている場合でも、エラースキップして回答自体は受け付ける仕様。

## ユーザーフロー
1. **作成**: ダッシュボードでアンケートを作成し、「受付中」にする。
2. **周知**: Discordで `/survey announce id:X` を実行。
3. **回答**:
    * ユーザーがリンクをクリックし、Discordでログイン。
    * フォームに入力して送信。
    * DBに保存（または更新）され、BotからDMが届く。
4. **集計**: 管理者はダッシュボードでグラフ確認やCSVダウンロードを行う。