name: CI/CD Deploy

on:
  push:
    branches: [master, test]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug Path
        run: |
          ls -l /home/devuser/.local/bin/uv
          whoami
          pwd
          ls -la /home/devuser
          ls -la /home/devuser/.local/bin
          ls -la /home/devuser/.cargo/bin

      - name: Ensure uv is installed
        run: |
          # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å…ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç¢ºå®Ÿã«ä½œæˆã—ã€æ‰€æœ‰æ¨©ã‚’è‡ªåˆ†ã«ã™ã‚‹
          sudo mkdir -p /home/devuser/.local/bin
          sudo chown -R devuser:devuser /home/devuser/.local

          if [ ! -f "/home/devuser/.local/bin/uv" ]; then
            echo "ðŸ“¦ uv ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™..."
            # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆè‡ªä½“ã‚’ sudo ã§å®Ÿè¡Œã™ã‚‹ã‹ã€
            # å®Ÿè¡Œå¾Œã«ãƒã‚¤ãƒŠãƒªã®ç§»å‹•ãƒ»æ¨©é™è¨­å®šã‚’ sudo ã§è¡Œã†
            curl -LsSf https://astral.sh/uv/install.sh | sh
            
            # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç›´å¾Œã«å®Ÿè¡Œæ¨©é™ã‚’å¿µæŠ¼ã—ã§ä»˜ä¸Ž
            chmod +x /home/devuser/.local/bin/uv
          fi

          echo "/home/devuser/.local/bin" >> $GITHUB_PATH

      - name: Build Rust bridge
        working-directory: ./database_bridge
        run: cargo build --release

      - name: Sync to production directory
        run: |
          sudo rsync -av --exclude='.git' ./ /Awaji-Empire-Agent/

      - name: Install dependencies
        working-directory: /Awaji-Empire-Agent/discord_bot
        run: |
          uv sync

      - name: Restart Services
        run: |
          sudo systemctl daemon-reload
          sudo systemctl restart discord_bot.service
          sudo systemctl restart discord_webapp.service
